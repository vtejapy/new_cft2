name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'cloudformation/**'
      - '.github/workflows/**'

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  validate-templates:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install cfn-lint boto3 pyyaml
          
      - name: Run cfn-lint
        id: cfn-lint
        run: |
          cd cloudformation
          echo "## CloudFormation Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Lint main template
          echo "### Main Template" >> $GITHUB_STEP_SUMMARY
          if cfn-lint main.yaml; then
            echo "✅ main.yaml - Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ main.yaml - Failed" >> $GITHUB_STEP_SUMMARY
            cfn-lint main.yaml >> $GITHUB_STEP_SUMMARY 2>&1
          fi
          
          # Lint all templates
          for template in templates/*.yaml; do
            echo "### $(basename $template)" >> $GITHUB_STEP_SUMMARY
            if cfn-lint "$template"; then
              echo "✅ $(basename $template) - Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ $(basename $template) - Failed" >> $GITHUB_STEP_SUMMARY
              cfn-lint "$template" >> $GITHUB_STEP_SUMMARY 2>&1
            fi
          done
          
      - name: Validate JSON parameter files
        run: |
          cd cloudformation
          echo "## Parameter File Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for param_file in parameters/*.json; do
            echo "### $(basename $param_file)" >> $GITHUB_STEP_SUMMARY
            if python -m json.tool "$param_file" > /dev/null 2>&1; then
              echo "✅ Valid JSON" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Invalid JSON" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
      - name: Security scan with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: cloudformation/
          framework: cloudformation
          output_format: json
          output_file_path: checkov-report.json
        continue-on-error: true
        
      - name: Process Checkov results
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f checkov-report.json ]; then
            passed=$(jq '.summary.passed' checkov-report.json)
            failed=$(jq '.summary.failed' checkov-report.json)
            skipped=$(jq '.summary.skipped' checkov-report.json)
            
            echo "- ✅ Passed: $passed" >> $GITHUB_STEP_SUMMARY
            echo "- ❌ Failed: $failed" >> $GITHUB_STEP_SUMMARY
            echo "- ⏭️ Skipped: $skipped" >> $GITHUB_STEP_SUMMARY
            
            if [ "$failed" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failed Checks:" >> $GITHUB_STEP_SUMMARY
              jq -r '.results.failed_checks[] | "- \(.check_id): \(.check_name)"' checkov-report.json >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: Comment PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## CloudFormation Validation Results\n\n${summary}`
            });

  check-costs:
    name: Estimate AWS Costs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Estimate costs
        id: cost-estimate
        run: |
          cd cloudformation
          
          echo "## Cost Estimation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estimated Monthly Costs (USD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Simple cost estimation based on resource types
          # In production, use AWS Cost Explorer API or third-party tools
          
          echo "| Environment | Estimated Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Development | ~$500-750 |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ~$1,000-1,500 |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ~$2,500-3,500 |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** These are rough estimates. Actual costs depend on usage." >> $GITHUB_STEP_SUMMARY
          
  dry-run:
    name: CloudFormation Dry Run
    runs-on: ubuntu-latest
    needs: [validate-templates]
    permissions:
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Create change set
        run: |
          cd cloudformation
          
          STACK_NAME="pr-validation-${{ github.event.pull_request.number }}"
          CHANGE_SET_NAME="pr-${{ github.event.pull_request.number }}-${{ github.run_number }}"
          
          # Create change set for validation
          aws cloudformation create-change-set \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGE_SET_NAME \
            --template-body file://main.yaml \
            --parameters file://parameters/dev.json \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --change-set-type CREATE \
            || true
            
          # Wait for change set creation
          aws cloudformation wait change-set-create-complete \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGE_SET_NAME \
            || true
            
          # Describe change set
          aws cloudformation describe-change-set \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGE_SET_NAME \
            --query 'Changes[*].[Type,ResourceChange.Action,ResourceChange.LogicalResourceId,ResourceChange.ResourceType]' \
            --output table >> $GITHUB_STEP_SUMMARY || true
            
          # Delete the change set and stack
          aws cloudformation delete-change-set \
            --stack-name $STACK_NAME \
            --change-set-name $CHANGE_SET_NAME \
            || true
            
          aws cloudformation delete-stack \
            --stack-name $STACK_NAME \
            || true
